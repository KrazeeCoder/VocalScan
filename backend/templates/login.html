{% extends 'base.html' %}
{% block content %}
<div class="mx-auto max-w-md mt-10 card p-6">
  <h1 class="text-2xl font-semibold mb-4">Sign in to VocalScan</h1>
  <p class="text-sm text-gray-600 mb-6">Use your email/password or Google to continue.</p>
  <form id="emailLoginForm" class="space-y-3">
    <input class="block w-full rounded-md border border-gray-300 px-3 py-2" id="email" type="email" placeholder="Email" required />
    <input class="block w-full rounded-md border border-gray-300 px-3 py-2" id="password" type="password" placeholder="Password" required />
    <button class="inline-flex items-center px-4 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 w-full" type="submit">Sign In</button>
  </form>
  <div class="my-4 text-center text-gray-500">or</div>
  <button id="googleBtn" class="inline-flex items-center px-4 py-2 rounded-md border border-indigo-600 text-indigo-700 hover:bg-indigo-50 w-full">Continue with Google</button>
  <p class="text-xs text-gray-500 mt-4">New here? <a href="#" id="registerLink" class="text-indigo-600">Create an account</a></p>
</div>
{% endblock %}

{% block scripts %}
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const auth = window.vsFirebase.auth;
    const provider = new firebase.auth.GoogleAuthProvider();

    // Function to check demographics status and redirect appropriately
    async function checkDemographicsAndRedirect(user) {
      try {
        const idToken = await user.getIdToken();
        const response = await fetch('/demographics/status', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${idToken}`
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.demographicsCompleted) {
            location.href = '/record'; // Go to main app
          } else {
            location.href = '/demographics'; // Complete demographics first
          }
        } else {
          // If can't check status, assume demographics needed
          location.href = '/demographics';
        }
      } catch (error) {
        console.error('Error checking demographics status:', error);
        // Default to demographics page on error
        location.href = '/demographics';
      }
    }

    document.getElementById('emailLoginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        await checkDemographicsAndRedirect(userCredential.user);
      } catch (err) {
        alert(err.message || 'Failed to sign in');
      }
    });

    document.getElementById('registerLink').addEventListener('click', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!email || !password) { alert('Enter email and password then click again'); return; }
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        // New users always need to complete demographics
        location.href = '/demographics';
      } catch (err) {
        alert(err.message || 'Failed to register');
      }
    });

    document.getElementById('googleBtn').addEventListener('click', async () => {
      try {
        const userCredential = await auth.signInWithPopup(provider);
        await checkDemographicsAndRedirect(userCredential.user);
      } catch (err) {
        alert(err.message || 'Google sign-in failed');
      }
    });

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        await checkDemographicsAndRedirect(user);
      }
    });
  });
</script>
{% endblock %}


