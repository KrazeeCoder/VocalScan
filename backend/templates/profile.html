{% extends 'base.html' %}
{% block content %}
<div class="mx-auto max-w-4xl mt-8 animate-fade-in">
  <div class="card p-8">
    <div class="mb-8">
      <h2 class="text-3xl font-bold text-white mb-2">Profile Settings</h2>
      <p class="text-dark-300">Manage your account information and preferences</p>
    </div>
    
    <div id="profileInfo" class="mb-8 p-4 bg-dark-800/50 rounded-xl border border-dark-600">
      <div class="text-sm text-dark-300"></div>
    </div>

    <div class="space-y-8">
      <div>
        <h3 class="text-xl font-bold text-white mb-4">Demographics</h3>
        <div class="mb-6 p-4 bg-primary-500/10 border border-primary-500/30 rounded-xl">
          <p class="text-primary-300 text-sm">
            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <a href="/demographics" class="text-primary-400 hover:text-primary-300 underline">Click here to update your demographic information</a>
          </p>
        </div>
        <form id="demoForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-dark-300 mb-2">First Name</label>
            <input id="firstName" class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-xl text-white placeholder-dark-400 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors" type="text" />
          </div>
          <div>
            <label class="block text-sm font-medium text-dark-300 mb-2">Last Name</label>
            <input id="lastName" class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-xl text-white placeholder-dark-400 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors" type="text" />
          </div>
          <div>
            <label class="block text-sm font-medium text-dark-300 mb-2">Age</label>
            <input id="age" class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-xl text-white placeholder-dark-400 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors" type="number" min="0" />
          </div>
          <div>
            <label class="block text-sm font-medium text-dark-300 mb-2">Sex</label>
            <select id="sex" class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-xl text-white focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors">
              <option value="">Select</option>
              <option>Female</option>
              <option>Male</option>
              <option>Non-binary</option>
              <option>Prefer not to say</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-dark-300 mb-2">Notes (e.g., PD diagnosis stage, meds)</label>
            <textarea id="notes" class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-xl text-white placeholder-dark-400 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors" rows="4" placeholder="Enter any relevant medical notes or information..."></textarea>
          </div>
          <div class="md:col-span-2 flex gap-4 items-center">
            <button class="btn-primary" id="saveDemoBtn" type="submit">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              Save Changes
            </button>
            <span id="demoStatus" class="text-dark-400 text-sm"></span>
          </div>
        </form>
      </div>

      <div class="border-t border-dark-600 pt-8">
        <h3 class="text-xl font-bold text-white mb-4">Account Actions</h3>
        <div class="flex gap-4">
          <button id="logoutBtn" class="btn-secondary">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
            </svg>
            Sign Out
          </button>
          <button id="deleteBtn" class="px-6 py-3 border border-red-500 text-red-400 hover:bg-red-500 hover:text-white rounded-xl font-medium transition-colors">
            <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            Delete Account
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const { auth, db } = window.vsFirebase;
  auth.onAuthStateChanged(async (user) => {
    if (!user) { 
      location.href = '/login'; 
      return; 
    }
    
    // Check demographics completion
    try {
      const idToken = await user.getIdToken();
      const response = await fetch('/demographics/status', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${idToken}`
        }
      });
      
      if (response.ok) {
        const result = await response.json();
        if (!result.demographicsCompleted) {
          location.href = '/demographics';
          return;
        }
      } else {
        location.href = '/demographics';
        return;
      }
    } catch (error) {
      console.error('Error checking demographics status:', error);
      location.href = '/demographics';
      return;
    }
    
    const el = document.getElementById('profileInfo');
    el.innerHTML = `
      <div class="flex items-center space-x-4">
        <div class="w-12 h-12 bg-gradient-to-br from-primary-500 to-primary-700 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
        </div>
        <div>
          <div class="text-white font-medium">Signed in as <strong>${user.displayName || user.email}</strong></div>
          <div class="text-dark-400 text-sm">UID: ${user.uid}</div>
        </div>
      </div>
    `;

    // Load demographics
    const doc = await db.collection('users').doc(user.uid).get();
    const d = doc.data() || {};
    document.getElementById('firstName').value = d.firstName || '';
    document.getElementById('lastName').value = d.lastName || '';
    document.getElementById('age').value = d.age || '';
    document.getElementById('sex').value = d.sex || '';
    document.getElementById('notes').value = d.notes || '';
  });

  document.getElementById('demoForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const user = auth.currentUser; if (!user) return;
    const data = {
      firstName: document.getElementById('firstName').value.trim(),
      lastName: document.getElementById('lastName').value.trim(),
      age: Number(document.getElementById('age').value) || null,
      sex: document.getElementById('sex').value,
      notes: document.getElementById('notes').value.trim(),
      updatedAt: new Date(),
    };
    const status = document.getElementById('demoStatus');
    const saveBtn = document.getElementById('saveDemoBtn');
    
    status.textContent = 'Saving...';
    status.className = 'text-yellow-400 text-sm';
    saveBtn.disabled = true;
    
    try {
      await db.collection('users').doc(user.uid).set(data, { merge: true });
      status.textContent = 'Changes saved successfully!';
      status.className = 'text-green-400 text-sm';
      setTimeout(() => {
        status.textContent = '';
      }, 3000);
    } catch (e) {
      status.textContent = e.message || 'Failed to save changes';
      status.className = 'text-red-400 text-sm';
    }
    
    saveBtn.disabled = false;
  });
  document.getElementById('logoutBtn').onclick = () => auth.signOut().then(()=>location.href='/login');
  document.getElementById('deleteBtn').onclick = async () => {
    const user = auth.currentUser; if (!user) return;
    if (!confirm('This will permanently delete your account. Continue?')) return;
    try { await user.delete(); alert('Account deleted'); location.href='/login'; }
    catch (e) { alert(e.message || 'Delete failed. Re-login and try again.'); }
  };
</script>
{% endblock %}


