{% extends 'base.html' %}
{% block content %}
<div class="mx-auto max-w-4xl mt-10 animate-fade-in">
  <!-- Page Header -->
  <div class="text-center mb-10">
    <div class="inline-flex items-center px-3 py-1 bg-blue-500/20 text-blue-400 text-sm font-medium rounded-full mb-4">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
      </svg>
      Profile Setup
    </div>
    <h1 class="text-4xl font-bold text-white mb-4">Complete Your Profile</h1>
    <p class="text-dark-300 text-lg leading-relaxed max-w-2xl mx-auto">Help us provide better analysis by sharing some demographic information. This information is securely stored and used only for improving your health assessments.</p>
  </div>
  
  <div class="card p-8">
    <form id="demographicsForm" class="space-y-10">
      
      <!-- Basic Information -->
      <div class="border-b border-dark-600 pb-8">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-3 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          Basic Information
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="age" class="block text-sm font-medium text-dark-300 mb-2">Age *</label>
            <input type="number" id="age" name="age" min="1" max="120" required 
                   class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-xl text-white placeholder-dark-400 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors" 
                   placeholder="Enter your age" />
          </div>
          <div>
            <label for="gender" class="block text-sm font-medium text-dark-300 mb-2">Gender *</label>
            <select id="gender" name="gender" required 
                    class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-xl text-white focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors">
              <option value="">Select gender</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="non-binary">Non-binary</option>
              <option value="prefer-not-to-say">Prefer not to say</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Medical History -->
      <div class="border-b border-dark-600 pb-8">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-3 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          Medical History
        </h2>
        <div class="space-y-6">
          <div>
            <label for="medicalHistory" class="block text-sm font-medium text-dark-300 mb-2">
              Do you have any diagnosed medical conditions? *
            </label>
            <select id="medicalHistory" name="medicalHistory" required 
                    class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-xl text-white focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors">
              <option value="">Select option</option>
              <option value="none">No diagnosed conditions</option>
              <option value="respiratory">Respiratory conditions (asthma, COPD, etc.)</option>
              <option value="neurological">Neurological conditions (Parkinson's, MS, etc.)</option>
              <option value="both">Both respiratory and neurological</option>
              <option value="other">Other medical conditions</option>
            </select>
          </div>
        
        <div>
          <label for="symptoms" class="block text-sm font-medium text-dark-300 mb-3">
            Current symptoms (check all that apply)
          </label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <label class="flex items-center p-3 bg-dark-800/50 border border-dark-600 rounded-xl hover:border-primary-500 transition-colors cursor-pointer">
              <input type="checkbox" name="symptoms" value="voice-changes" class="mr-3 w-4 h-4 text-primary-600 bg-dark-700 border-dark-500 rounded focus:ring-primary-500">
              <span class="text-dark-200">Voice changes</span>
            </label>
            <label class="flex items-center p-3 bg-dark-800/50 border border-dark-600 rounded-xl hover:border-primary-500 transition-colors cursor-pointer">
              <input type="checkbox" name="symptoms" value="breathing-difficulty" class="mr-3 w-4 h-4 text-primary-600 bg-dark-700 border-dark-500 rounded focus:ring-primary-500">
              <span class="text-dark-200">Breathing difficulty</span>
            </label>
            <label class="flex items-center p-3 bg-dark-800/50 border border-dark-600 rounded-xl hover:border-primary-500 transition-colors cursor-pointer">
              <input type="checkbox" name="symptoms" value="tremor" class="mr-3 w-4 h-4 text-primary-600 bg-dark-700 border-dark-500 rounded focus:ring-primary-500">
              <span class="text-dark-200">Tremor</span>
            </label>
            <label class="flex items-center p-3 bg-dark-800/50 border border-dark-600 rounded-xl hover:border-primary-500 transition-colors cursor-pointer">
              <input type="checkbox" name="symptoms" value="coordination-issues" class="mr-3 w-4 h-4 text-primary-600 bg-dark-700 border-dark-500 rounded focus:ring-primary-500">
              <span class="text-dark-200">Coordination issues</span>
            </label>
            <label class="flex items-center p-3 bg-dark-800/50 border border-dark-600 rounded-xl hover:border-primary-500 transition-colors cursor-pointer">
              <input type="checkbox" name="symptoms" value="fatigue" class="mr-3 w-4 h-4 text-primary-600 bg-dark-700 border-dark-500 rounded focus:ring-primary-500">
              <span class="text-dark-200">Fatigue</span>
            </label>
            <label class="flex items-center p-3 bg-dark-800/50 border border-dark-600 rounded-xl hover:border-primary-500 transition-colors cursor-pointer">
              <input type="checkbox" name="symptoms" value="none" class="mr-3 w-4 h-4 text-primary-600 bg-dark-700 border-dark-500 rounded focus:ring-primary-500">
              <span class="text-dark-200">None</span>
            </label>
          </div>
        </div>

        <div>
          <label for="medications" class="block text-sm font-medium text-dark-300 mb-2">
            Current medications (optional)
          </label>
          <textarea id="medications" name="medications" rows="4" placeholder="List any medications you're currently taking..."
                    class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-xl text-white placeholder-dark-400 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors"></textarea>
        </div>
      </div>
    </div>

    <!-- Family History -->
    <div class="border-b border-dark-600 pb-8">
      <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
        <svg class="w-6 h-6 mr-3 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
        </svg>
        Family History
      </h2>
      <div>
        <label class="block text-sm font-medium text-dark-300 mb-3">
          Family history of conditions (check all that apply)
        </label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="flex items-center p-3 bg-dark-800/50 border border-dark-600 rounded-xl hover:border-primary-500 transition-colors cursor-pointer">
            <input type="checkbox" name="familyHistory" value="parkinsons" class="mr-3 w-4 h-4 text-primary-600 bg-dark-700 border-dark-500 rounded focus:ring-primary-500">
            <span class="text-dark-200">Parkinson's disease</span>
          </label>
          <label class="flex items-center p-3 bg-dark-800/50 border border-dark-600 rounded-xl hover:border-primary-500 transition-colors cursor-pointer">
            <input type="checkbox" name="familyHistory" value="alzheimers" class="mr-3 w-4 h-4 text-primary-600 bg-dark-700 border-dark-500 rounded focus:ring-primary-500">
            <span class="text-dark-200">Alzheimer's disease</span>
          </label>
          <label class="flex items-center p-3 bg-dark-800/50 border border-dark-600 rounded-xl hover:border-primary-500 transition-colors cursor-pointer">
            <input type="checkbox" name="familyHistory" value="respiratory" class="mr-3 w-4 h-4 text-primary-600 bg-dark-700 border-dark-500 rounded focus:ring-primary-500">
            <span class="text-dark-200">Respiratory conditions</span>
          </label>
          <label class="flex items-center p-3 bg-dark-800/50 border border-dark-600 rounded-xl hover:border-primary-500 transition-colors cursor-pointer">
            <input type="checkbox" name="familyHistory" value="neurological" class="mr-3 w-4 h-4 text-primary-600 bg-dark-700 border-dark-500 rounded focus:ring-primary-500">
            <span class="text-dark-200">Other neurological conditions</span>
          </label>
          <label class="flex items-center p-3 bg-dark-800/50 border border-dark-600 rounded-xl hover:border-primary-500 transition-colors cursor-pointer">
            <input type="checkbox" name="familyHistory" value="none" class="mr-3 w-4 h-4 text-primary-600 bg-dark-700 border-dark-500 rounded focus:ring-primary-500">
            <span class="text-dark-200">None known</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Lifestyle -->
    <div class="border-b border-dark-600 pb-8">
      <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
        <svg class="w-6 h-6 mr-3 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
        </svg>
        Lifestyle Information
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="smoking" class="block text-sm font-medium text-dark-300 mb-2">Smoking status</label>
          <select id="smoking" name="smoking" 
                  class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-xl text-white focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors">
            <option value="">Select option</option>
            <option value="never">Never smoked</option>
            <option value="former">Former smoker</option>
            <option value="current">Current smoker</option>
          </select>
        </div>
        <div>
          <label for="exercise" class="block text-sm font-medium text-dark-300 mb-2">Exercise frequency</label>
          <select id="exercise" name="exercise" 
                  class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-xl text-white focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors">
            <option value="">Select option</option>
            <option value="none">No regular exercise</option>
            <option value="light">Light (1-2 times/week)</option>
            <option value="moderate">Moderate (3-4 times/week)</option>
            <option value="heavy">Heavy (5+ times/week)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Contact Information -->
    <div class="border-b border-dark-600 pb-8">
      <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
        <svg class="w-6 h-6 mr-3 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
        </svg>
        Contact Information (Optional)
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="phone" class="block text-sm font-medium text-dark-300 mb-2">Phone number</label>
          <input type="tel" id="phone" name="phone" placeholder="Enter your phone number"
                 class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-xl text-white placeholder-dark-400 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors" />
        </div>
        <div>
          <label for="preferredContact" class="block text-sm font-medium text-dark-300 mb-2">Preferred contact method</label>
          <select id="preferredContact" name="preferredContact" 
                  class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-xl text-white focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors">
            <option value="">Select option</option>
            <option value="email">Email</option>
            <option value="phone">Phone</option>
            <option value="none">No contact preferred</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Emergency Contact -->
    <div class="pb-8">
      <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
        <svg class="w-6 h-6 mr-3 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
        </svg>
        Emergency Contact (Optional)
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label for="emergencyName" class="block text-sm font-medium text-dark-300 mb-2">Full name</label>
          <input type="text" id="emergencyName" name="emergencyName" placeholder="Emergency contact name"
                 class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-xl text-white placeholder-dark-400 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors" />
        </div>
        <div>
          <label for="emergencyPhone" class="block text-sm font-medium text-dark-300 mb-2">Phone number</label>
          <input type="tel" id="emergencyPhone" name="emergencyPhone" placeholder="Emergency contact phone"
                 class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-xl text-white placeholder-dark-400 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors" />
        </div>
        <div>
          <label for="emergencyRelation" class="block text-sm font-medium text-dark-300 mb-2">Relationship</label>
          <input type="text" id="emergencyRelation" name="emergencyRelation" placeholder="e.g., Spouse, Parent, Friend"
                 class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-xl text-white placeholder-dark-400 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors" />
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="pt-8 text-center">
      <button type="submit" 
              class="px-8 py-4 bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center mx-auto">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        Complete Profile & Continue
      </button>
      <p class="text-sm text-dark-400 mt-4 max-w-md mx-auto">
        By submitting this form, you agree to share this information for improving your health assessments.
      </p>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const auth = window.vsFirebase.auth;
  
  // Check if user is authenticated
  auth.onAuthStateChanged((user) => {
    if (!user) {
      location.href = '/login';
      return;
    }
  });

  // Handle form submission
  document.getElementById('demographicsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const user = auth.currentUser;
    if (!user) {
      alert('Please log in first');
      location.href = '/login';
      return;
    }

    // Collect form data
    const formData = new FormData(e.target);
    const data = {};
    
    // Get simple form fields
    data.age = parseInt(formData.get('age'));
    data.gender = formData.get('gender');
    data.medicalHistory = formData.get('medicalHistory');
    
    // Get checkbox arrays
    data.symptoms = formData.getAll('symptoms');
    data.familyHistory = formData.getAll('familyHistory');
    
    // Get medications as array (split by lines)
    const medicationsText = formData.get('medications');
    data.medications = medicationsText ? medicationsText.split('\n').filter(m => m.trim()) : [];
    
    // Get lifestyle data
    data.lifestyle = {
      smoking: formData.get('smoking'),
      exercise: formData.get('exercise')
    };
    
    // Get contact info
    data.contactInfo = {
      phone: formData.get('phone'),
      preferredContact: formData.get('preferredContact')
    };
    
    // Get emergency contact
    data.emergencyContact = {
      name: formData.get('emergencyName'),
      phone: formData.get('emergencyPhone'),
      relationship: formData.get('emergencyRelation')
    };

    try {
      // Get Firebase ID token
      const idToken = await user.getIdToken();
      
      // Submit to backend
      const response = await fetch('/demographics', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${idToken}`
        },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (response.ok) {
        alert('Profile completed successfully!');
        location.href = '/dashboard'; // Redirect to dashboard for welcome flow
      } else {
        alert('Error: ' + (result.error || 'Failed to save demographics'));
      }
    } catch (error) {
      console.error('Error submitting demographics:', error);
      alert('Failed to submit demographics. Please try again.');
    }
  });
});
</script>
{% endblock %}
